# Chrome on device Miko chat sample — Chrome 拡張機能

[Prompt API（Built-in AI / Gemini Nano）](https://developer.chrome.com/docs/ai/built-in)を使った、完全オンデバイスで動作するチャット Chrome 拡張機能です。外部サーバー不要、APIキー不要 — すべてブラウザ内で完結します。

> **[English README](./README.md)**

## 注意事項

- このリポジトリは、学習・検証のための**ローカル専用サンプル実装**です。
- このままの状態での**本番利用**や Chrome Web Store への公開は想定していません。
- サンプルを簡潔に保つため、プロンプトインジェクション耐性などのセキュリティ強化は限定的です。
- 検証時は、チャット履歴に機密情報や個人情報を入力しないでください。
- 本プロジェクトで使用しているキャラクター「ミコ」は、公式ガイドラインに基づき利用しています（商用利用可・無料・クレジット任意）。最新条件は公式ページを確認してください: https://miko.aituberonair.com

## 特徴

- Chrome の Built-in AI（Gemini Nano）によるオンデバイス推論
- ポップアップを閉じても会話履歴が保持される（`chrome.storage.local` 使用）
- 文脈復元 — セッション再作成時に直近の会話履歴をシステムプロンプトに注入し、AIが文脈を維持
- モデルの利用可否を自動検出してステータス表示
- モデルダウンロード中の自動ポーリング
- 入力バリデーション（4,000文字制限）と二重送信防止
- アクセシビリティ対応（`aria-label`、キーボード操作：Enter で送信、Shift+Enter で改行）
- 安全な DOM 操作（`textContent` のみ使用、ユーザー入力に `innerHTML` を使わない）
- Manifest V3、最小権限（`storage`, `tts`）、外部通信なし

## 前提条件

| 要件 | 詳細 |
|---|---|
| Chrome バージョン | **138 以降**（Dev または Canary チャンネル推奨） |
| OS | Windows、macOS、Linux（十分なディスク容量と RAM が必要） |

### Built-in AI フラグの有効化

1. `chrome://flags` を開き、以下のフラグを有効にします:

   | フラグ | 設定値 |
   |---|---|
   | `#optimization-guide-on-device-model` | **Enabled BypassPerfRequirement** |
   | `#prompt-api-for-gemini-nano` | **Enabled** |

2. フラグ変更後、Chrome を再起動します。

   > モデルの初回準備にはネットワーク速度に応じて数分かかる場合があります。拡張機能はモデルが利用可能になると自動的に検出します。

## インストール

1. このリポジトリをクローンまたはダウンロードします:

   ```bash
   git clone https://github.com/shinshin86/chrome-on-device-miko-chat-sample.git
   ```

2. Chrome で `chrome://extensions` を開きます。

3. 右上の **「デベロッパーモード」** を有効にします。

4. **「パッケージ化されていない拡張機能を読み込む」** をクリックし、プロジェクトフォルダ（`manifest.json` があるディレクトリ）を選択します。

5. ツールバーに拡張機能のアイコンが表示されます。

## 使い方

1. ツールバーの拡張機能アイコンをクリックしてチャットポップアップを開きます。
2. ヘッダーのステータス表示を確認します:
   - **緑** — 「利用可能（オンデバイス）」: すぐに使えます
   - **黄** — 「ダウンロード中…」: モデルのダウンロード中です。しばらくお待ちください
   - **赤** — エラー: メッセージの内容を確認し、必要な対応を行ってください
3. テキストエリアにメッセージを入力し、**Enter** で送信します（**Shift+Enter** で改行）。
4. AIの応答がチャット領域に表示されます。
5. ポップアップを閉じて再度開いても、会話履歴は保持されています。
6. **「リセット」** ボタンで会話履歴をクリアし、新しい会話を開始できます。

## ファイル構成

```
.
├── manifest.json   # 拡張機能マニフェスト（Manifest V3）
├── popup.html      # ポップアップ UI
├── popup.css       # ポップアップのスタイル
├── popup.js        # アプリケーションロジック（セッション管理、チャット、ストレージ）
├── README.md       # 英語版 README
└── README_ja.md    # このファイル
```

## 技術的な詳細

### 会話コンテキストの復元

ポップアップを再度開くと、新しい `LanguageModel` セッションが作成されます。会話の文脈を維持するために、直近20件のメッセージを `User:` / `Assistant:` の形式でシステムプロンプトに注入しています。これにより、セッションがリセットされても AIが自然に会話を継続できます。

### ストレージの制限

- 最大 **40件** のメッセージを保存します。超過分は古い順に自動削除されます。
- 入力は1メッセージあたり **4,000文字** が上限です。

### モデルの可用性ポーリング

モデルのステータスが `downloadable` または `downloading` の場合、3秒ごとに `LanguageModel.availability()` をポーリングし（最大40回）、モデルが利用可能になると自動的にチャットを有効化します。

## トラブルシューティング

| 問題 | 対処法 |
|---|---|
| 「Prompt API 非対応」と表示される | Chrome 138 以降を使用し、必要なフラグが有効になっているか確認してください |
| 「ダウンロード中…」のまま完了しない | Chrome を再起動し、しばらく待ってから再度お試しください |
| ポーリングがタイムアウトした | Chrome を再起動してから再試行してください |
| AIの応答に文脈が反映されない | セッション再作成後に起こることがあります。直近20件のメッセージが文脈として復元されます |

## ライセンス

- コード: MIT（`LICENSE` を参照）
- キャラクター素材の利用条件: https://miko.aituberonair.com

